stages:
  - gen
  - staging
  - production

before_script:
  - 'which ssh-agent || ( apt-get update -y && apt-get install openssh-client -y )'
  - 'which jq || ( apt-get update -y && apt-get install jq -y )'
  - 'which curl || ( apt-get update -y && apt-get install curl -y )'
  - eval $(ssh-agent -s)
  - ssh-add <(echo "$GIT_SSH_PKEY")
  - git config --global url."ssh://git@g.ghn.vn".insteadOf "https://gido.vn"
  - git config --global user.email "gitbot@gido.vn"
  - git config --global user.name "Mr. Robot"
  - go get -u gido.vn/gic/databases/sqitch.git
  - go get -u gido.vn/gic/databases/sqitch.git/scripts/deploy-sqitch
  - export CM_MSG=$(./git_msg.sh)
  
gen:
  stage: gen
  script:
    - sqitch.git -schema/schema.yml -name ${CI_COMMIT_SHORT_SHA}-${CM_MSG} -d "$CM_MSG"
  rules:
    - changes:
      - .gitlab-ci.yml
      when: never
    - when: always
    
staging:
  stage: staging
  script:
    - make deploy_stag
  rules:
    - changes:
      - .gitlab-ci.yml
      when: never
    - when: manual

production:
  stage: production
  script:
    - make deploy_prod
  rules:
    - changes:
      - .gitlab-ci.yml
      when: never
    - when: manual
